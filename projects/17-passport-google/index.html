<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google OAuth 登录演示</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
      <!-- 加载状态 -->
      <div id="loadingSection" class="hidden text-center">
        <div
          class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"
        ></div>
        <p class="text-gray-600">正在登录中...</p>
      </div>

      <!-- 登录状态 -->
      <div id="loginSection" class="text-center">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">欢迎登录</h1>
        <p class="text-gray-600 mb-6">使用 Google 账号快速登录</p>

        <!-- Google 登录按钮 -->
        <button
          id="googleLoginBtn"
          class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-3 text-lg"
        >
          <svg class="w-6 h-6" viewBox="0 0 24 24">
            <path
              fill="currentColor"
              d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
            />
            <path
              fill="currentColor"
              d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
            />
            <path
              fill="currentColor"
              d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
            />
            <path
              fill="currentColor"
              d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
            />
          </svg>
          使用 Google 登录
        </button>

        <p class="text-xs text-gray-500 mt-4">
          点击登录即表示您同意我们的服务条款和隐私政策
        </p>
      </div>

      <!-- 用户信息展示 -->
      <div id="userSection" class="hidden text-center">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">登录成功！</h1>

        <!-- 用户头像 -->
        <div class="mb-4">
          <img
            id="userAvatar"
            class="w-20 h-20 rounded-full mx-auto border-4 border-green-500 object-cover"
            src=""
            alt="用户头像"
          />
        </div>

        <!-- 用户信息 -->
        <div class="space-y-3 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-600">姓名</label>
            <p id="userName" class="text-lg font-semibold text-gray-800"></p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-600">邮箱</label>
            <p id="userEmail" class="text-lg text-gray-700"></p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-600"
              >用户ID</label
            >
            <p id="userId" class="text-sm text-gray-500 font-mono"></p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-600"
              >登录状态</label
            >
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
            >
              ✓ 已认证
            </span>
          </div>
        </div>

        <!-- 操作按钮 -->
        <div class="space-y-3">
          <button
            id="dashboardBtn"
            class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200"
          >
            进入应用
          </button>

          <button
            id="logoutBtn"
            class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200"
          >
            退出登录
          </button>
        </div>
      </div>

      <!-- 错误信息 -->
      <div id="errorSection" class="hidden text-center">
        <div
          class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"
        >
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                clip-rule="evenodd"
              ></path>
            </svg>
            <div>
              <strong>登录失败！</strong>
              <div id="errorMessage">请稍后重试</div>
            </div>
          </div>
        </div>

        <button
          id="retryBtn"
          class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200"
        >
          重新登录
        </button>
      </div>
    </div>

    <script>
      // 配置
      const CONFIG = {
        API_BASE_URL: 'http://localhost:3000', // NestJS后端地址（改为3000）
        FRONTEND_BASE_URL: 'http://127.0.0.1:5500', // Live Server地址
      };

      // 全局变量
      let currentUser = null;

      // Google 登录函数
      function initiateGoogleLogin() {
        // 显示加载状态
        showLoading();

        // 重定向到后端的Google OAuth端点
        window.location.href = `${CONFIG.API_BASE_URL}/google`;
      }

      // 显示加载状态
      function showLoading() {
        hideAllSections();
        document.getElementById('loadingSection').classList.remove('hidden');
      }

      // 显示登录界面
      function showLogin() {
        hideAllSections();
        document.getElementById('loginSection').classList.remove('hidden');
      }

      // 显示用户信息
      function showUserInfo(user) {
        hideAllSections();

        const userSection = document.getElementById('userSection');
        userSection.classList.remove('hidden');

        // 填充用户信息
        document.getElementById('userAvatar').src =
          user.avatar ||
          'https://picsum.photos/300/200?random=' + Math.random();
        document.getElementById('userName').textContent =
          user.name ||
          `${user.firstName} ${user.lastName}`.trim() ||
          '未知用户';
        document.getElementById('userEmail').textContent = user.email || '';
        document.getElementById('userId').textContent = user.id || '';

        // 存储用户信息
        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(user));
      }

      // 显示错误信息
      function showError(message) {
        hideAllSections();

        const errorSection = document.getElementById('errorSection');
        errorSection.classList.remove('hidden');
        document.getElementById('errorMessage').textContent = message;
      }

      // 隐藏所有区域
      function hideAllSections() {
        const sections = [
          'loginSection',
          'userSection',
          'errorSection',
          'loadingSection',
        ];
        sections.forEach((sectionId) => {
          document.getElementById(sectionId).classList.add('hidden');
        });
      }

      // 退出登录
      function logout() {
        // 清除本地存储
        localStorage.removeItem('currentUser');
        localStorage.removeItem('access_token');
        currentUser = null;

        // 清除后端cookies（通过请求logout端点）
        fetch(`${CONFIG.API_BASE_URL}/logout`, {
          method: 'POST',
          credentials: 'include', // 包含cookies
        }).catch((err) => console.log('Logout request failed:', err));

        // 显示登录界面
        showLogin();
      }

      // 解析URL参数
      function parseUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const user = {};

        // 从URL参数中提取用户信息
        const paramMap = {
          token: 'token',
          userId: 'id',
          email: 'email',
          name: 'name',
          firstName: 'firstName',
          lastName: 'lastName',
          avatar: 'avatar',
        };

        for (const [paramName, userKey] of Object.entries(paramMap)) {
          const value = urlParams.get(paramName);
          if (value) {
            user[userKey] = decodeURIComponent(value);
          }
        }

        return Object.keys(user).length > 0 ? user : null;
      }

      // 检查认证状态
      function checkAuthStatus() {
        // 1. 检查URL参数（从后端重定向）
        const urlParams = new URLSearchParams(window.location.search);

        // 检查是否有错误参数
        if (urlParams.get('error')) {
          showError('Google登录失败，请重试');
          return;
        }

        const userFromUrl = parseUrlParams();
        if (userFromUrl && userFromUrl.id) {
          console.log('从URL获取用户信息:', userFromUrl);

          // 清理URL参数
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname,
          );

          // 显示用户信息
          showUserInfo(userFromUrl);
          return;
        }

        // 2. 检查本地存储
        const savedUser = localStorage.getItem('currentUser');
        const savedToken = localStorage.getItem('access_token');

        if (savedUser && savedToken) {
          try {
            const user = JSON.parse(savedUser);
            console.log('从本地存储恢复用户信息:', user);
            showUserInfo(user);
            return;
          } catch (error) {
            console.error('解析本地用户信息失败:', error);
            localStorage.removeItem('currentUser');
            localStorage.removeItem('access_token');
          }
        }

        // 4. 默认显示登录界面
        showLogin();
      }

      // 事件监听器
      document.addEventListener('DOMContentLoaded', function () {
        // Google登录按钮
        document
          .getElementById('googleLoginBtn')
          .addEventListener('click', function (e) {
            e.preventDefault();
            initiateGoogleLogin();
          });

        // 退出登录按钮
        document
          .getElementById('logoutBtn')
          .addEventListener('click', function (e) {
            e.preventDefault();
            logout();
          });

        // 重试按钮
        document
          .getElementById('retryBtn')
          .addEventListener('click', function (e) {
            e.preventDefault();
            showLogin();
          });

        // 进入应用按钮
        document
          .getElementById('dashboardBtn')
          .addEventListener('click', function (e) {
            e.preventDefault();
            // 这里可以重定向到你的主应用页面
            alert('跳转到主应用（请根据需要修改此逻辑）');
          });

        // 初始化页面状态
        checkAuthStatus();
      });

      // 监听页面显示事件（用户返回页面时）
      window.addEventListener('pageshow', function (event) {
        if (event.persisted) {
          // 页面从缓存中恢复，重新检查状态
          checkAuthStatus();
        }
      });
    </script>
  </body>
</html>
